# h3copenr
OpenR running on H3C device，包括openr和fibservice两部分，openr学习路由发送到fibservice，fibservice下发路由到H3C设备。

[![Build Status](https://www.travis-ci.org/h3copen/h3copenr.svg?branch=master)](https://www.travis-ci.org/h3copen/h3copenr) 

## openr在设备上运行
### openr运行
1：可直接 docker pull lmke/h3c_openr:v2 即可拿到openr镜像

2：之后按以下命令启动容器  
设备端：  
docker run -it --name openr1 --network container:comware --sysctl net.ipv6.conf.all.disable_ipv6=0 lmke/h3c_openr:v2 bash  
注：此条命令适用于设备上启动openr,如果在PC中测试，需要参照/build/test.sh,其中关于IP地址的设定和网关设定可忽略。   
pc端：  
docker run -it --name openr1 --sysctl net.ipv6.conf.all.disable_ipv6=0 lmke/h3c_openr:v2 bash  
注：不管设备还是PC端，我们都需要至少2个openr。

3:openr 的网络设置  
设备端：  
在设备端中我们在启动命令中已经设计了相应网络 --network conatine:comware  
除此之外，我们至少需要两台设备，并保证两台设备间有一个物理连接，可直接ping通。在两台设备上分别运行设备端启动openr容器命令.    
pc端：
我们需创建docker 网络  
docker create net1  
docker create net2  
docker create net3  
至少需要3个net,2个openr  
docker network connect net1 openr1  
docker network connect net2 openr1  
docker network connect net2 openr2  
docker network connect net3 openr2  

4:openr 运行  
此时以启动openr容器，之后进去openr容器，在每个openr的根目录下运行    
run_openr.sh test.cfg > openr.log 2>&1 &   
注：test.cfg在设备和PC端测试时对应内容不同，镜像中的test.cfg适用于设备环境，PC端测试环境需使用本仓库的test.cfg。设备端和PC端对应的命令相同。   

此时openr程序已经启动，log会输入到openr.log中。一部分log在/tmp目录下。
注意：opern运行后需要启动fib容器openr才能正常运行。

5：fib容器运行


### openr相关命令
openr运行后可使用breeze 命令与其进行交互
常用的有breeze fib routes； breeze lm links等。
可输入breeze后会打印相关参数，查看具体有哪些命令。

## openr编译
### openr目录结构
在openr目录中有build和openr两个目录，在build目录中提供了build_openr.sh，运行这个脚本即可自动编译openr，注：完整编译需要环境可访问github.com。openr目录中存放的是完整的代码。

### 安装
openr会将所需的库和头文件安装到/usr/local/lib和/usr/local/include中，相关安装过程在上述脚本中会自动执行。

## Fibservice 
### 编译
fibservice将openr路由转发到H3C，cd /fibservice/fibhandler 执行go build编译生成fibhanlder，执行 ./fibhandler -h可以查看参数含义。
### 运行
fibservice 运行在另一个容器ubuntu16.04中，用dockerfile生成，接着为每个openr创建对应的fib容器，fib容器和对应的openr容器共享网络，可参考[`h3copenr/build/test.h`](https://github.com/h3copen/h3copenr/blob/master/build/test.sh)。  
注：fibservice的使用在设备和PC端基本一致，都是与openr共享网络，不同的是pc段测试不要加-gc参数，而设备端需要，请参考test.sh.    

## Travis-ci 编译
在顶层目录中，我们包含了一个yml文件，在这其中，我们会拉取镜像，创建容器，在容器中下载最新代码，编译openr。此外我们还会编译fibservice，编译成功后，我们会拉取新镜像运行openr和fibservice。之后会运行测试脚本，比较openr发出的路由和fibservice接收的路由是否相同。  


## openr runnging in our device
### run openr

you can use the command "docker pull lmke/h3c_openr:v2"to get the openr image,
then use the following command  to start container  
docker run -it --name openr1 --network container:comware --sysctl net.ipv6.conf.all.disable_ipv6=0 lmke/h3c_openr:v2 bash  
and now the container has been started,next we attach the container,under the root dir,we enter
the following command :
run_openr.sh test.cfg > openr.log 2>&1 &  
and now the openr programme has been started ,and the log will en redirect to openr.log , a part 
of log will be written in /tmp .
NOTICE: you need to start fibservice if you want to run openr,otherwise, the openr will be blocked. 

### command about openr
After the openr runs, it can interact with it by using the breeze command.Commonly used are breeze fib routes; breeze lm links, etc.
After entering breeze, the relevant parameters will be printed to see which commands are available.

## Openr compilation
### Openr directory structure
There are two directories in the openr directory, build and openr. The build_openr.sh is provided in the build directory. You can compile the openr automatically by running this script. Note: The complete compilation requires the environment to access github.com. The complete code is stored in the openr directory.


### Installation  
Libraries and header files will be installed into the `/usr/local/lib` and `/usr/local/include`. Installation will be executed automatically in scripts. 

## Fibservice
### Build
Fibservice forwards openr routes to H3C device. Get into directory `/fibservice/fibhandler`. The command `go build` compile source file and generate the `fibhandler`. Usage of  `./fibhandler -h ` to view the meaning of parameters.
### Run
Fibservice run in an other container, generated by dockerfile. An openr container corresponds to a fibservice container. Openr and fibservice Shared the same network. For more information, please refer to [`h3copenr/build/test.h`](https://github.com/h3copen/h3copenr/blob/master/build/test.sh).

## Travis-ci Build
In the top-level directory, include a YML file. In the yml, pull up the image, create the container, download the latest code in the container, and compile openr and fibservice. After the compilation is successful, pull the new image and run openr and fibsrvice. Finally，the test script is run to compare whether the routes sent by openr are the same as those received by fibservice.
